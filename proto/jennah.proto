syntax = "proto3";

package jennah.v1;


option go_package = "github.com/alphauslabs/jennah/gen/proto;jennahv1";

// ComplexityLevel classifies a job by its resource/hardware requirements.
// Used by the routing layer to select the appropriate GCP execution service.
enum ComplexityLevel {
  COMPLEXITY_LEVEL_UNSPECIFIED = 0;
  // SIMPLE: no machine type, very low CPU/memory, short duration (<= 10 min).
  // Routes to Cloud Tasks.
  COMPLEXITY_LEVEL_SIMPLE = 1;
  // MEDIUM: no specific machine type, moderate resources, duration <= 1 hour.
  // Routes to Cloud Run Jobs.
  COMPLEXITY_LEVEL_MEDIUM = 2;
  // COMPLEX: specific machine type requested, heavy resources, or long duration.
  // Routes to Cloud Batch.
  COMPLEXITY_LEVEL_COMPLEX = 3;
}

// AssignedService indicates which GCP execution service will run the job.
enum AssignedService {
  ASSIGNED_SERVICE_UNSPECIFIED = 0;
  ASSIGNED_SERVICE_CLOUD_TASKS = 1;
  ASSIGNED_SERVICE_CLOUD_RUN_JOB = 2;
  ASSIGNED_SERVICE_CLOUD_BATCH = 3;
}

// Main service definition for Jennah.
service DeploymentService {
  // Submit a job for deployment.
  rpc SubmitJob(SubmitJobRequest) returns (SubmitJobResponse);
  // List all jobs for the current tenant.
  rpc ListJobs(ListJobsRequest) returns (ListJobsResponse);
  // Get the current tenant's information.
  rpc GetCurrentTenant(GetCurrentTenantRequest) returns (GetCurrentTenantResponse);
  // Cancel a job (only for PENDING, SCHEDULED, or RUNNING states).
  rpc CancelJob(CancelJobRequest) returns (CancelJobResponse);
  // Delete a job from the system.
  rpc DeleteJob(DeleteJobRequest) returns (DeleteJobResponse);
  // Get a single job's full details.
  rpc GetJob(GetJobRequest) returns (GetJobResponse);
}


// ResourceOverride allows callers to specify custom compute resource values.
// Any zero-value field is filled in from the resolved preset (or default).
message ResourceOverride {
  // cpu_millis is CPU in milli-cores (e.g. 1000 = 1 vCPU). 0 means use preset value.
  int64 cpu_millis = 1;
  // memory_mib is memory in mebibytes (e.g. 4096 = 4 GiB). 0 means use preset value.
  int64 memory_mib = 2;
  // max_run_duration_seconds is the job timeout in seconds. 0 means use preset value.
  int64 max_run_duration_seconds = 3;
}

message SubmitJobRequest {
  // Canonical internal job ID generated by gateway.
  // If empty, worker may generate one for backward compatibility.
  string job_id = 1;
  string image_uri = 2;
  map<string, string> env_vars = 3; // Example: { "DB_HOST": "10.0.0.1", "DEBUG": "true" }
  // resource_profile selects a named preset: "small", "medium", "large", "xlarge".
  // Defaults to "medium" when empty.
  string resource_profile = 4;
  // resource_override provides inline resource values that take precedence over the preset.
  // Partial overrides are supported â€” zero fields fall back to the resolved preset.
  ResourceOverride resource_override = 5;
  // Optional user-provided job name.
  string name = 6;
  // Resolved machine type: "e2-standard-4", "n1-standard-16", etc.
  string machine_type = 7;
  // Boot disk size in GB (default: 50).
  int64 boot_disk_size_gb = 8;
  // Whether to use Spot VMs (default: false).
  bool use_spot_vms = 9;
  // Custom service account email (optional).
  string service_account = 10;
  // Commands to execute in the container.
  repeated string commands = 11;
}

message SubmitJobResponse {
  string job_id = 1;
  string status = 2;
  string worker_assigned = 3;
  // Complexity tier assigned by the routing classifier: SIMPLE, MEDIUM, or COMPLEX.
  string complexity_level = 4;
  // GCP service assigned to execute this job: CLOUD_TASKS, CLOUD_RUN_JOB, or CLOUD_BATCH.
  string assigned_service = 5;
  // Human-readable explanation of why this routing decision was made.
  string routing_reason = 6;
}

message ListJobsRequest {
}

message ListJobsResponse {
  repeated Job jobs = 1;
}

message Job {
  string job_id = 1;
  string tenant_id = 2;
  string image_uri = 3;
  string status = 4;
  string created_at = 5;
  string updated_at = 6;
  string scheduled_at = 7;
  string started_at = 8;
  string completed_at = 9;
  int64 retry_count = 10;
  int64 max_retries = 11;
  string error_message = 12;
  string gcp_batch_job_name = 13;
  repeated string commands = 14;
  string env_vars_json = 15;
  string gcp_batch_task_group = 16;
  // User-facing job name.
  string name = 17;
  // Resource preset used at submission: "small", "medium", "large", "xlarge".
  string resource_profile = 18;
  // Resolved machine type: "e2-standard-4", "n1-standard-16", etc.
  string machine_type = 19;
  // Boot disk size in GB.
  int64 boot_disk_size_gb = 20;
  // Whether Spot VMs were requested.
  bool use_spot_vms = 21;
  // Custom service account email (optional).
  string service_account = 22;
}

message GetCurrentTenantRequest {
}

message GetCurrentTenantResponse {
  string tenant_id = 1;
  string user_email = 2;
  string oauth_provider = 3; // "google", "github"
  string created_at = 4;
}

message CancelJobRequest {
  string job_id = 1;
}

message CancelJobResponse {
  string job_id = 1;
  string status = 2;
}

message DeleteJobRequest {
  string job_id = 1;
}

message DeleteJobResponse {
  string job_id = 1;
  string message = 2;
}

message GetJobRequest {
  string job_id = 1;
}

message GetJobResponse {
  Job job = 1;
}