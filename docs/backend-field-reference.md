# SubmitJob Implementation - Backend Field Reference

This document is for backend engineers and contains the complete field mapping from the frontend `SubmitJobRequest` through the internal `JobConfig` struct to the final GCP Batch `batchpb.Job` structure.

---

## Field Mapping Overview

```
SubmitJobRequest (Proto)
    ↓
JobConfig (Internal Struct)
    ↓
batchpb.Job (GCP Batch API)
    ↓
GCP Batch Job Resource
```

---

## Complete Field Reference

### Image & Container Execution

#### `image_uri` (SubmitJobRequest) → `ImageURI` (JobConfig) → `batchpb.Runnable_Container.ImageUri`

- **Type**: string
- **Required**: Yes
- **Path**: Proto field #2
- **Backend**: Passed directly to GCP Batch
- **Validation**: Non-empty string, valid container registry URI

#### `commands` (SubmitJobRequest) → `Commands` (JobConfig) → `batchpb.Runnable_Container.Commands`

- **Type**: repeated string (array)
- **Required**: No
- **Path**: Proto field #11
- **Backend**: Split into separate command arguments for GCP Batch
- **Default**: Container's built-in CMD
- **Notes**: Appended to/overrides CMD, not parsed as shell

---

### Compute Resources

#### `resource_profile` (SubmitJobRequest) → (Resolved to CPU/Memory) → `JobConfig.Resources`

- **Type**: string (enum)
- **Valid values**: "small", "medium", "large", "xlarge"
- **Path**: Proto field #4
- **Backend mapping**:
  - small → CPUMillis: 2000, MemoryMiB: 2048, MaxRunDurationSeconds: 1800
  - medium → CPUMillis: 4000, MemoryMiB: 4096, MaxRunDurationSeconds: 3600
  - large → CPUMillis: 8000, MemoryMiB: 8192, MaxRunDurationSeconds: 7200
  - xlarge → CPUMillis: 16000, MemoryMiB: 16384, MaxRunDurationSeconds: 14400
- **Resolution**: `config.ResolveResources(profile, override)` in [internal/config/job_config.go](internal/config/job_config.go)
- **GCP mapping**: → `batchpb.TaskSpec.ComputeResource.CpuMilli` and `.MemoryMib`

#### `resource_override` (SubmitJobRequest) → (Merged into Resources) → `JobConfig.Resources`

- **Type**: nested ResourceOverride struct
- **Path**: Proto field #5
- **Fields**:
  - `cpu_millis` (int64, default 0) → overrides `Resources.CPUMillis`
  - `memory_mib` (int64, default 0) → overrides `Resources.MemoryMiB`
  - `max_run_duration_seconds` (int64, default 0) → overrides `Resources.MaxRunDurationSeconds`
- **Behavior**: Zero values are skipped; non-zero values override preset
- **GCP mapping**:
  - CPUMillis → `batchpb.TaskSpec.ComputeResource.CpuMilli`
  - MemoryMiB → `batchpb.TaskSpec.ComputeResource.MemoryMib`
  - MaxRunDurationSeconds → `durationpb.Duration` in `batchpb.TaskSpec.MaxRunDuration`

#### `boot_disk_size_gb` (SubmitJobRequest) → `BootDiskSizeGb` (JobConfig) → `batchpb.AllocationPolicy_Disk.SizeGb`

- **Type**: int64
- **Default**: 50 (GB)
- **Path**: Proto field #8
- **Validation**: 10 ≤ size ≤ 65536
- **Backend conversion**:
  - Stored in `BootDiskSizeGb` as GB
  - Converted to MiB in GCP: `BootDiskSizeGb * 1024` → `batchpb.TaskSpec.ComputeResource.BootDiskMib`
- **Also maps to**: `batchpb.AllocationPolicy_InstancePolicy.BootDisk.SizeGb` (raw GB value)

#### `machine_type` (SubmitJobRequest) → `MachineType` (JobConfig) → `batchpb.AllocationPolicy_InstancePolicy.MachineType`

- **Type**: string
- **Default**: null (GCP auto-selects based on CPU/memory)
- **Path**: Proto field #7
- **Examples**: "e2-standard-4", "n1-standard-16", "e2-highmem-2"
- **Validation**: Must be a valid GCP machine type in asia-northeast1 region
- **Backend**: Passed directly to GCP Allocation Policy

#### `use_spot_vms` (SubmitJobRequest) → `UseSpotVMs` (JobConfig) → `batchpb.AllocationPolicy_InstancePolicy.ProvisioningModel`

- **Type**: bool
- **Default**: false
- **Path**: Proto field #9
- **GCP mapping**:
  - true → `AllocationPolicy_SPOT`
  - false → `AllocationPolicy_STANDARD`

---

### Networking & Security

#### `service_account` (SubmitJobRequest) → `ServiceAccount` (JobConfig) → `batchpb.AllocationPolicy.ServiceAccount.Email`

- **Type**: string (email format)
- **Default**: null (uses default Compute Engine SA)
- **Path**: Proto field #10
- **Format**: `name@project.iam.gserviceaccount.com`
- **Backend**:
  - Email set in `AllocationPolicy.ServiceAccount.Email`
  - Default scopes: `["https://www.googleapis.com/auth/cloud-platform"]`

---

### Job Naming

#### `name` (SubmitJobRequest) → `name` (stored in DB) → (Provider job ID generation)

- **Type**: string
- **Default**: null
- **Path**: Proto field #6
- **Function**: Used in `generateProviderJobID()` to create GCP Batch-compatible job ID
- **Logic**: `jennah-{name}` if provided, else `jennah-{uuid[:8]}`
- **Max length**: Provider IDs must be ≤ 63 chars

#### `job_id` (SubmitJobRequest) → `job_id` (JobConfig as RequestID) → `batchpb.CreateJobRequest.RequestId`

- **Type**: string (UUID)
- **Default**: Generated by gateway if empty
- **Path**: Proto field #1
- **Backend usage**: `RequestID` for idempotent submissions
- **GCP mapping**: → `batchpb.CreateJobRequest.RequestId` for deduplication

---

### Environment Variables

#### `env_vars` (SubmitJobRequest) → `EnvVars` (JobConfig) → `batchpb.Runnable.Environment.Variables`

- **Type**: map<string, string>
- **Default**: empty (inherit from image)
- **Path**: Proto field #3
- **Backend**: Stored in DB as `env_vars_json` (JSON serialization)
- **GCP mapping**: Passed directly to `batchpb.Environment.Variables`

---

### Task & Instance Configuration (Requires `TaskGroupConfig`)

#### `TaskGroup.TaskCount` (JobConfig) → `batchpb.TaskGroup.TaskCount`

- **Type**: int64
- **Default**: 1
- **Backend**: Currently hardcoded to 1; will support N tasks in future
- **GCP mapping**: → Task group task count

#### `TaskGroup.Parallelism` (JobConfig) → `batchpb.TaskGroup.Parallelism`

- **Type**: int64
- **Default**: 0 (unlimited)
- **GCP mapping**: Max concurrent tasks
- **Constraint**: Must be ≤ TaskCount; 0 or unset = unlimited

#### `TaskGroup.SchedulingPolicy` (JobConfig) → `batchpb.TaskGroup.SchedulingPolicy`

- **Type**: string (enum)
- **Values**: "AS_SOON_AS_POSSIBLE", "IN_ORDER"
- **Default**: "AS_SOON_AS_POSSIBLE"
- **GCP mapping**: Converted to `batchpb.TaskGroup_AS_SOON_AS_POSSIBLE` or `batchpb.TaskGroup_IN_ORDER`

#### `TaskGroup.RequireHostsFile` (JobConfig) → `batchpb.TaskGroup.RequireHostsFile`

- **Type**: bool
- **Default**: false
- **GCP behavior**: Populates `/etc/hosts` with all task IPs for multi-VM jobs

#### `TaskGroup.PermissiveSsh` (JobConfig) → `batchpb.TaskGroup.PermissiveSsh`

- **Type**: bool
- **Default**: false
- **GCP behavior**: Enables passwordless SSH between task VMs

#### `TaskGroup.RunAsNonRoot` (JobConfig) → `batchpb.TaskGroup.RunAsNonRoot`

- **Type**: bool
- **Default**: false
- **GCP behavior**: Enforces non-root container execution

#### `TaskGroup.TaskCountPerNode` (JobConfig) → `batchpb.TaskGroup.TaskCountPerNode`

- **Type**: int64
- **Default**: 0 (no limit)
- **GCP behavior**: Controls task density per VM

---

### Advanced Configuration (Not Yet in Proto)

These fields are defined in `JobConfig` and can be set by the backend but are not yet exposed via the proto API. They're available for future frontend expansion.

#### `MachineType` (JobConfig, already exposed in proto)

See [Networking & Security](#networking--security) section

#### `MinCpuPlatform` (JobConfig)

- **Type**: string
- **Examples**: "Intel Cascade Lake", "AMD EPYC Rome", "Intel Skylake"
- **GCP mapping**: → `batchpb.AllocationPolicy_InstancePolicy.MinCpuPlatform`
- **Use case**: Enforce specific processor generation for consistency
- **Currently set by**: Backend only, not user-configurable

#### `Accelerators` (JobConfig)

- **Type**: `*AcceleratorConfig` struct
  - `Type` (string): GPU type, e.g., "nvidia-tesla-t4", "nvidia-tesla-v100", "tpu-v4"
  - `Count` (int64): Number of GPUs/TPUs
  - `DriverVersion` (string, optional): Specific driver version
- **GCP mapping**: → `batchpb.AllocationPolicy_InstancePolicy.Accelerators`
- **Currently set by**: Backend only; GPU support coming to proto

#### `InstallGpuDrivers` (JobConfig)

- **Type**: bool
- **GCP mapping**: → `batchpb.AllocationPolicy_InstancePolicyOrTemplate.InstallGpuDrivers`
- **Behavior**: Auto-install GPU drivers from Google Cloud
- **Currently set by**: Backend only

#### `InstallOpsAgent` (JobConfig)

- **Type**: bool
- **GCP mapping**: → `batchpb.AllocationPolicy_InstancePolicyOrTemplate.InstallOpsAgent`
- **Behavior**: Auto-install Google Cloud Operations Agent
- **Currently set by**: Backend only

#### `BlockProjectSshKeys` (JobConfig)

- **Type**: bool
- **GCP mapping**: → `batchpb.AllocationPolicy_InstancePolicyOrTemplate.BlockProjectSshKeys`
- **Behavior**: Prevents project-level SSH keys from accessing VMs
- **Currently set by**: Backend only

#### `BlockExternalIP` (JobConfig)

- **Type**: bool
- **GCP mapping**: → `batchpb.AllocationPolicy_NetworkInterface.NoExternalIpAddress`
- **Behavior**: Disable external IPs for private networking
- **Currently set by**: Backend only

#### `NetworkName` (JobConfig)

- **Type**: string
- **Format**: "projects/{project}/global/networks/{network}"
- **GCP mapping**: → `batchpb.AllocationPolicy_NetworkInterface.Network`
- **Currently set by**: Backend only

#### `SubnetworkName` (JobConfig)

- **Type**: string
- **Format**: "projects/{project}/regions/{region}/subnetworks/{subnet}"
- **GCP mapping**: → `batchpb.AllocationPolicy_NetworkInterface.Subnetwork`
- **Currently set by**: Backend only

#### `AllowedLocations` (JobConfig)

- **Type**: []string
- **Examples**: ["us-central1", "us-west1"]
- **GCP mapping**: → `batchpb.AllocationPolicy_LocationPolicy.AllowedLocations`
- **Behavior**: Restrict VM creation to specified regions
- **Currently set by**: Backend only

#### `Priority` (JobConfig)

- **Type**: int64
- **Range**: 0-100 (100 is highest)
- **Default**: 0
- **GCP mapping**: → `batchpb.Job.Priority`
- **Currently set by**: Backend only

#### `JobLabels` (JobConfig)

- **Type**: map[string]string
- **GCP mapping**: → `batchpb.Job.Labels`
- **Use case**: Organization, billing tracking
- **Currently set by**: Backend only

#### `RequestID` (JobConfig)

- **Type**: string (UUID format)
- **GCP mapping**: → `batchpb.CreateJobRequest.RequestId`
- **Behavior**: Prevents duplicate submissions (idempotent)
- **Currently set by**: Backend (uses `job_id` as RequestID)

#### `MaxRetryCount` (JobConfig)

- **Type**: int32
- **Range**: 0-10
- **Default**: 0 (no retries)
- **GCP mapping**: → `batchpb.TaskSpec.MaxRetryCount`
- **Behavior**: Auto-retry failed tasks
- **Currently set by**: Backend only

#### `ContainerEntrypoint` (JobConfig)

- **Type**: string
- **GCP mapping**: → `batchpb.Runnable_Container.Entrypoint`
- **Behavior**: Override container ENTRYPOINT
- **Currently set by**: Backend only; not exposed in proto

---

## Data Flow Diagram

```
Frontend (SubmitJobRequest)
    ├─ image_uri
    ├─ commands
    ├─ env_vars
    ├─ resource_profile + resource_override
    ├─ machine_type
    ├─ boot_disk_size_gb
    ├─ use_spot_vms
    ├─ service_account
    └─ name
        ↓
    Gateway (cmd/gateway/service/handlers.go)
        • Validates OAuth headers
        • Creates/retrieves tenant
        • Routes to worker via consistent hashing
        ↓
    Worker (cmd/worker/service/handlers.go)
        • Validates image_uri
        • Generates job IDs
        • Creates JobConfig
        • Calls batch provider
        ↓
    GCP Batch Provider (internal/batch/gcp/client.go)
        • Builds batchpb.Job
        • Builds AllocationPolicy with InstancePolicy
        • Builds TaskGroup
        • Calls CreateJob API
        ↓
    Database (Cloud Spanner)
        • Stores Job record (status, timestamps, GCP resource path)
        • Stores Job state transitions (audit trail)
        ↓
    GCP Batch API
        • Creates job resource
        • Allocates compute resources
        • Runs container
        ↓
    Job Status Polling (background worker goroutine)
        • Periodically checks job status
        • Updates database
```

---

## Error Handling & Validation

### Input Validation (in `SubmitJob` handler)

| Field               | Validation                           | Error Code         |
| ------------------- | ------------------------------------ | ------------------ |
| `image_uri`         | Non-empty                            | `INVALID_ARGUMENT` |
| `boot_disk_size_gb` | ≥10 if specified                     | `INVALID_ARGUMENT` |
| `resource_profile`  | One of: small, medium, large, xlarge | `INVALID_ARGUMENT` |
| `machine_type`      | Valid GCP type (if specified)        | `INVALID_ARGUMENT` |

### Database Constraints

- `TenantId`: Foreign key to Tenants table
- `JobId`: Unique within tenant
- `Status`: Enum constrained to valid job statuses
- `GcpBatchJobName`: Reference to GCP resource

### GCP Batch Constraints

- `JobId`: 63 chars max, alphanumeric + hyphens only
- `Machine type`: Must be available in job region (asia-northeast1)
- `Boot disk size`: 10 GB minimum, 65536 GB maximum
- `CPU/Memory`: Must be compatible with machine type

---

## Implementation Files

### Key Locations

| Component               | File                                                               | Function                                      |
| ----------------------- | ------------------------------------------------------------------ | --------------------------------------------- |
| **Proto Definition**    | [proto/jennah.proto](proto/jennah.proto)                           | SubmitJobRequest message                      |
| **JobConfig Struct**    | [internal/batch/provider.go](internal/batch/provider.go)           | JobConfig, TaskGroupConfig, AcceleratorConfig |
| **Resource Resolution** | [internal/config/job_config.go](internal/config/job_config.go)     | ResolveResources()                            |
| **GCP Provider**        | [internal/batch/gcp/client.go](internal/batch/gcp/client.go)       | SubmitJob() implementation                    |
| **Gateway Handler**     | [cmd/gateway/service/handlers.go](cmd/gateway/service/handlers.go) | Routes to worker                              |
| **Worker Handler**      | [cmd/worker/service/handlers.go](cmd/worker/service/handlers.go)   | Validates, creates JobConfig, calls provider  |
| **Database ORM**        | [internal/database/jobs.go](internal/database/jobs.go)             | Job CRUD operations                           |

---

## Future Extensions

### Proto Additions (Planned)

- GPU/accelerator support in SubmitJobRequest
- Multi-task job submission (TaskGroup array)
- Advanced networking (VPC, subnet)
- Custom CPU platform selection
- Job priority levels
- Environment variables from Secret Manager

### Backend Extensibility

The current JobConfig struct can accommodate all GCP Batch fields without proto changes:

- Minimal proto changes needed
- Backend can accept values via alternative APIs
- Admin/programmatic interfaces can use JobConfig directly

---

## Testing & Validation

### Unit Test Coverage

See [cmd/worker/service/handlers_test.go] (when added) for:

- Field validation tests
- Resource profile resolution
- JobConfig construction
- GCP proto mapping

### Integration Test Pattern

```bash
# Submit a job
curl -X POST http://localhost:8080/jennah.v1.DeploymentService/SubmitJob \
  -H "Authorization: Bearer $TOKEN" \
  -d '{"image_uri": "alpine:latest", "commands": ["echo", "hello"]}'

# Response:
# {"job_id": "...", "status": "PENDING", "worker_assigned": "..."}

# Check status
curl http://localhost:8080/jennah.v1.DeploymentService/GetJob \
  -H "Authorization: Bearer $TOKEN" \
  -d '{"job_id": "..."}'
```

---

## Performance Considerations

- **JobConfig size**: Minimal memory footprint (~1 KB per job)
- **Serialization**: Proto binary (small, efficient)
- **Database storage**: Interleaved tables co-locate related data
- **GCP Batch delay**: Job submission typically 1-5 seconds
- **Status polling**: Default 5-second intervals (configurable)

---
